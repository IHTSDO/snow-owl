<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
	<modelVersion>4.0.0</modelVersion>
	<artifactId>com.b2international.snowowl.server.target.update</artifactId>
	<packaging>eclipse-repository</packaging>
	
	<parent>
		<groupId>com.b2international.snowowl</groupId>
		<artifactId>releng-parent</artifactId>
		<version>4.2.0-SNAPSHOT</version>
	</parent>

	<properties>
		<update.site>dependencies</update.site>
		<repository.name>target_platform_${target.platform.version}</repository.name>
	</properties>
	
	<build>
		<plugins>
			<plugin>
				<groupId>org.eclipse.tycho</groupId>
				<artifactId>target-platform-configuration</artifactId>
				<version>${tycho.version}</version>
				<configuration combine.self="override">
					<resolver>p2</resolver>
					<pomDependencies>consider</pomDependencies>
					<filters>
						<!-- Restricted Logging API and implementation to version of Virgo 3.6.x -->
						<filter>
							<type>osgi-bundle</type>
							<id>com.google.guava</id>
							<restrictTo>
								<versionRange>[15.0.0,16.0.0)</versionRange>
							</restrictTo>
						</filter>
						<filter>
							<type>p2-installable-unit</type>
							<id>org.slf4j.api</id>
							<restrictTo>
								<versionRange>[1.7.2,1.7.3)</versionRange>
							</restrictTo>
						</filter>
						<filter>
							<type>p2-installable-unit</type>
							<id>ch.qos.logback.classic</id>
							<restrictTo>
								<versionRange>[1.0.7,1.0.8)</versionRange>
							</restrictTo>
						</filter>
						<filter>
							<type>p2-installable-unit</type>
							<id>ch.qos.logback.core</id>
							<restrictTo>
								<versionRange>[1.0.7,1.0.8)</versionRange>
							</restrictTo>
						</filter>
						<filter>
							<type>p2-installable-unit</type>
							<id>ch.qos.logback.slf4j</id>
							<restrictTo>
								<versionRange>[1.0.7,1.0.8)</versionRange>
							</restrictTo>
						</filter>
						<filter>
							<type>p2-installable-unit</type>
							<id>org.eclipse.swt.cocoa.macosx.x86_64</id>
							<restrictTo>
								<versionRange>[3.8.0,3.9.0)</versionRange>
							</restrictTo>
						</filter>
						<filter>
							<type>p2-installable-unit</type>
							<id>org.eclipse.swt.gtk.linux.x86_64</id>
							<restrictTo>
								<versionRange>[3.8.0,3.9.0)</versionRange>
							</restrictTo>
						</filter>
						<filter>
							<type>p2-installable-unit</type>
							<id>org.eclipse.swt.win32.win32.x86_64</id>
							<restrictTo>
								<versionRange>[3.8.0,3.9.0)</versionRange>
							</restrictTo>
						</filter>
					</filters>
					<environments>
						<environment>
							<os>macosx</os>
							<ws>cocoa</ws>
							<arch>x86_64</arch>
						</environment>
						<environment>
							<os>win32</os>
							<ws>win32</ws>
							<arch>x86_64</arch>
						</environment>
						<environment>
							<os>linux</os>
							<ws>gtk</ws>
							<arch>x86_64</arch>
						</environment>
					</environments>
				</configuration>
			</plugin>
			<plugin>
				<groupId>org.eclipse.tycho.extras</groupId>
				<artifactId>tycho-p2-extras-plugin</artifactId>
				<version>${tycho-extras.version}</version>
				<executions>
					<!-- Move final content to the destination folder -->
					<execution>
						<id>copy-content-to-site</id>
						<phase>verify</phase>
						<goals>
							<goal>mirror</goal>
						</goals>
						<configuration>
							<source>
								<repository>
									<url>${project.build.directory}/repository</url>
								</repository>
							</source>
							<destination>${download.publish.path}</destination>
						</configuration>
					</execution>
				</executions>
			</plugin>
			<plugin>
				<groupId>org.eclipse.tycho</groupId>
				<artifactId>tycho-p2-repository-plugin</artifactId>
				<executions>
					<execution>
						<id>default-assemble-repository</id>
						<phase>package</phase>
						<goals>
							<goal>assemble-repository</goal>
						</goals>
						<configuration>
							<includeAllDependencies>true</includeAllDependencies>
						</configuration>
					</execution>
				</executions>
			</plugin>
			<plugin>
				<groupId>org.eclipse.tycho.extras</groupId>
				<artifactId>tycho-eclipserun-plugin</artifactId>
				<version>${tycho-extras.version}</version>
				<configuration>
					<argLine>-Declipse.p2.mirrors=false</argLine>
					<appArgLine>-nosplash -consoleLog -application org.eclipse.equinox.p2.repository.repo2runnable -source ${project.build.directory}/repository -destination ${project.build.directory}/${repository.name}</appArgLine>
					<dependencies>
	                    <dependency>
	                        <artifactId>org.eclipse.equinox.p2.transport.ecf</artifactId>
	                        <type>eclipse-plugin</type>
	                    </dependency>
	                    <dependency>
	                        <artifactId>org.eclipse.equinox.p2.repository</artifactId>
	                        <type>eclipse-plugin</type>
	                    </dependency>
	                    <dependency>
	                        <artifactId>org.eclipse.equinox.p2.touchpoint.natives</artifactId>
	                        <type>eclipse-plugin</type>
	                    </dependency>
	                    <dependency>
	                        <artifactId>org.eclipse.equinox.p2.touchpoint.eclipse</artifactId>
	                        <type>eclipse-plugin</type>
	                    </dependency>
	                    <dependency>
	                        <artifactId>org.eclipse.equinox.p2.artifact.repository</artifactId>
	                        <type>eclipse-plugin</type>
	                    </dependency>
	                    <dependency>
	                        <artifactId>org.eclipse.equinox.p2.repository.tools</artifactId>
	                        <type>eclipse-plugin</type>
	                    </dependency>
	                    <dependency>
	                        <artifactId>org.eclipse.equinox.ds</artifactId>
	                        <type>eclipse-plugin</type>
	                    </dependency>
			    		<dependency>
							<artifactId>org.eclipse.core.net</artifactId>
							<type>eclipse-plugin</type>
		    			</dependency>
                	</dependencies>
                	<repositories>
                		<repository>
							<id>kepler</id>
							<url>http://download.eclipse.org/releases/kepler</url>
							<layout>p2</layout>
						</repository>
                	</repositories>
				</configuration>
				<executions>
					<execution>
						<id>assemble-target-platform</id>
						<phase>integration-test</phase>
						<goals>
							<goal>eclipse-run</goal>
						</goals>
					</execution>
				</executions>
			</plugin>
			<plugin>
				<groupId>com.github.goldin</groupId>
				<artifactId>copy-maven-plugin</artifactId>
				<version>0.2.5</version>
				<executions>
					<execution>
						<id>copy-zip-to-site</id>
						<goals>
							<goal>copy</goal>
						</goals>
						<phase>verify</phase>
						<configuration>
							<resources>
								<resource>
									<directory>${project.build.directory}/${repository.name}</directory>
									<targetPath>${project.build.directory}/${repository.name}_${maven.build.timestamp}.zip</targetPath>
									<exclude>**/org.eclipse.rap*</exclude>
									<pack>true</pack>
								</resource>
								<resource>
									<directory>${project.build.directory}</directory>
									<targetPath>${download.publish.path}</targetPath>
									<include>${repository.name}_${maven.build.timestamp}.zip</include>
								</resource>
							</resources>
						</configuration>
					</execution>
				</executions>
			</plugin>
		</plugins>
	</build>

	<profiles>
		<profile>
			<id>clean</id>
			<activation>
				<property>
					<name>clean_repository</name>
					<value>true</value>
				</property>
			</activation>
			<build>
				<plugins>
					<plugin>
						<groupId>org.apache.maven.plugins</groupId>
						<artifactId>maven-clean-plugin</artifactId>
						<version>2.3</version>
						<executions>
							<execution>
								<id>clean_repo</id>
								<phase>clean</phase>
								<goals>
									<goal>clean</goal>
								</goals>
								<configuration>
									<followSymLinks>false</followSymLinks>
									<excludeDefaultDirectories>true</excludeDefaultDirectories>
									<filesets>
										<fileset>
											<directory>${download.publish.path}</directory>
											<includes>
												<include>**/*</include>
											</includes>
										</fileset>
									</filesets>
								</configuration>
							</execution>
						</executions>
					</plugin>
				</plugins>
			</build>
		</profile>
	</profiles>
</project>